print("Starting ccDHD v2.1...")
dofile("config")
dofile("utils")
dofile("uiBase")
dofile("uiSystem")
dofile("uiGate")
dofile("uiDialing")
dofile("uiUser")
dofile("uiDiagnostics")
dofile("gate")
dofile("inputCore")
dofile("inputDialing")
dofile("inputUser")
dofile("inputGate")
dofile("inputSystem")
dofile("inputKeys")
dofile("auth")
dofile("address")

local function detectVersion()
    if config.VERSION_MODE ~= "auto" then
        return config.VERSION_MODE == "1122"
    end
    local testGate = peripheral.find("stargate")
    if testGate and testGate.getEnergyStored then
        return true
    end
    return false
end
isVersion1122 = detectVersion()
logAction("Detected version: " .. (isVersion1122 and "1.12.2" or "1.7.10"))

loadConfig()
print("Config loaded, proceeding to login")
logAction("Starting login")
if not checkPassword() then
    term.clear()
    term.setCursorPos(1, 1)
    print("Access Denied")
    logAction("Access denied")
    return
end
print("Login successful, finding gates")
logAction("Login completed, initializing gates")
if not findGates() then
    term.clear()
    term.setCursorPos(1, 1)
    print("No Stargates found on network.")
    logAction("No Stargates found")
    sleep(2)
end
loadAddressBook()
maxVisibleLines = config.MAX_VISIBLE_LINES or 13

term.clear()
term.setCursorPos(1, 1)
term.write("Initializing Stargate...")
if not syncWithGate() then
    term.setCursorPos(1, 2)
    term.write("Failed to sync with gate. Check logs.")
    sleep(2)
else
    term.setCursorPos(1, 2)
    term.write("Connected to: " .. (config.gateNames[gateName] or gateName or "None") .. " at: " .. localAddress)
    sleep(1)
end

updateMainPage()
if config.AUTO_DIAL_ADDRESS and isValidAddress(config.AUTO_DIAL_ADDRESS) then
    if not dialGate(config.AUTO_DIAL_ADDRESS) then
        logAction("Auto-dial failed for: " .. config.AUTO_DIAL_ADDRESS)
    end
elseif config.PRE_DIAL_ADDRESS then
    if not preDialAddress() then
        logAction("Pre-dial failed.")
    end
end

mainLoop()