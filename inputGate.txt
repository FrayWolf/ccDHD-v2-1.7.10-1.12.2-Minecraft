function handleGateSelectionInput()
    registerInput(6, keys.s, function(event, param)
        if #stargates > 0 then
            gateName = stargates[selectedIndex]
            logAction("Selected gate: " .. (config.gateNames[gateName] or gateName))
            if syncWithGate() then
                currentPage = 1
                return true
            else
                term.setCursorPos(4, 15)
                term.setTextColor(config.UI_COLORS.warning)
                term.write("Sync failed! Check logs.")
                term.setTextColor(config.UI_COLORS.text or colors.white)
                sleep(1)
                currentPage = 2
                return false
            end
        end
    end)
    registerInput(6, keys.up, function(event, param)
        if selectedIndex > 1 then
            selectedIndex = selectedIndex - 1
            if selectedIndex < scrollPos then scrollPos = selectedIndex end
        end
    end)
    registerInput(6, keys.down, function(event, param)
        if selectedIndex < #stargates then
            selectedIndex = selectedIndex + 1
            if selectedIndex > scrollPos + maxVisibleLines - 1 then scrollPos = selectedIndex - maxVisibleLines + 1 end
        end
    end)
    return handleInputLoop(updateGateSelectionPage, 6)
end

function handleNameGateInput()
    local inputState = "name"
    dialingAddress = ""
    local gateX, gateY, gateZ, compX, compY, compZ = "", "", "", "", "", ""
    
    local function updateNameGatePageCustom()
        drawPage("Name Gate & Coordinates", {
            {text = string.rep("-", 49), y = 3},
            {text = "Current: " .. (config.gateNames[gateName] or gateName or "None"), y = 5},
            {text = "New Name: " .. (inputState == "name" and dialingAddress or config.gateNames[gateName] or ""), y = 6},
            {text = "Gate X: " .. (inputState == "gateX" and dialingAddress or gateX), y = 8},
            {text = "Gate Y: " .. (inputState == "gateY" and dialingAddress or gateY), y = 9},
            {text = "Gate Z: " .. (inputState == "gateZ" and dialingAddress or gateZ), y = 10},
            {text = "Comp X: " .. (inputState == "compX" and dialingAddress or compX), y = 12},
            {text = "Comp Y: " .. (inputState == "compY" and dialingAddress or compY), y = 13},
            {text = "Comp Z: " .. (inputState == "compZ" and dialingAddress or compZ), y = 14},
            {text = string.rep("-", 49), y = 17},
            {text = "[Enter] Next  [F1] Back", y = 18, centered = true}
        })
    end

    registerInput(7, keys.enter, function(event, param)
        if #dialingAddress > 0 and gateName then
            if inputState == "name" then
                config.gateNames[gateName] = dialingAddress
                inputState = "gateX"
            elseif inputState == "gateX" then
                gateX = dialingAddress
                config.gatePositions[gateName] = config.gatePositions[gateName] or {}
                config.gatePositions[gateName].gateX = tonumber(gateX) or 0
                inputState = "gateY"
            elseif inputState == "gateY" then
                gateY = dialingAddress
                config.gatePositions[gateName].gateY = tonumber(gateY) or 0
                inputState = "gateZ"
            elseif inputState == "gateZ" then
                gateZ = dialingAddress
                config.gatePositions[gateName].gateZ = tonumber(gateZ) or 0
                inputState = "compX"
            elseif inputState == "compX" then
                compX = dialingAddress
                config.gatePositions[gateName].compX = tonumber(compX) or 0
                inputState = "compY"
            elseif inputState == "compY" then
                compY = dialingAddress
                config.gatePositions[gateName].compY = tonumber(compY) or 0
                inputState = "compZ"
            elseif inputState == "compZ" then
                compZ = dialingAddress
                config.gatePositions[gateName].compZ = tonumber(compZ) or 0
                if saveConfig() then
                    logAction("Updated Dos updated " .. gateName .. " - Name: " .. config.gateNames[gateName] .. ", Coords: " .. gateX .. "," .. gateY .. "," .. gateZ .. " to " .. compX .. "," .. compY .. "," .. compZ)
                    dialingAddress = ""
                    currentPage = 2
                    return true
                else
                    term.setCursorPos(4, 16)
                    term.setTextColor(config.UI_COLORS.warning)
                    term.write("Save failed! Check logs.")
                    term.setTextColor(config.UI_COLORS.text or colors.white)
                    sleep(1)
                end
            end
            dialingAddress = ""
        end
    end)
    registerInput(7, keys.backspace, function(event, param)
        if #dialingAddress > 0 then
            dialingAddress = dialingAddress:sub(1, -2)
        end
    end)
    return handleInputLoop(updateNameGatePageCustom, 7)
end

function handleGateHistoryInput()
    registerInput(14, keys.up, function(event, param)
        if scrollPos > 1 then
            scrollPos = scrollPos - 1
        end
    end)
    registerInput(14, keys.down, function(event, param)
        if scrollPos + 10 < #recentAddresses then
            scrollPos = scrollPos + 1
        end
    end)
    return handleInputLoop(updateGateHistoryPage, 14)
end