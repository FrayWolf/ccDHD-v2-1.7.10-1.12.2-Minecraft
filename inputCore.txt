currentFuncPage = 1

local inputActions = {}

function registerInput(page, key, action)
    -- Registers an input action for a specific page and key
    inputActions[page] = inputActions[page] or {}
    inputActions[page][key] = action
end

function handleInputLoop(updateFunc, pageId)
    -- Handles input using registered actions
    local function runLoop()
        updateFunc()
        while true do
            local event, param = os.pullEvent()
            if event == "char" or (event == "key" and param ~= keys.f1) then
                if inputActions[pageId] and inputActions[pageId][param] then
                    local result = inputActions[pageId][param](event, param)
                    if result ~= nil then return result end
                end
                updateFunc()
            elseif event == "key" and param == keys.f1 then
                return false
            end
        end
    end

    local success, result = pcall(runLoop)
    if not success then
        logAction("Input loop error: " .. tostring(result))
        return false
    end
    return result
end

function mainLoop()
    local lastSyncTime = os.clock()
    local pageHandlers = {
        [1] = function() 
            if os.clock() - lastSyncTime >= (config.SYNC_INTERVAL or 0.5) then
                syncWithGate()
                updateMainPage()
                lastSyncTime = os.clock()
            end
        end,
        [2] = updateSystemFunctionsPage,
        [3] = updateDialingPage,
        [4] = updateAddressBookPage,
        [6] = updateGateSelectionPage,
        [7] = updateNameGatePage,
        [8] = updateDiagnosticsPage,
        [10] = updateUserPermissionsPage,
        [11] = updateGateNetworkMap,
        [12] = updateSendMessagePage,
        [13] = updateCheckFuelPage,
        [14] = updateGateHistoryPage,
        [15] = updateSetAlarmPage,
        [16] = updateAppearanceSettingsPage
    }

    while true do
        local handler = pageHandlers[currentPage]
        if handler then 
            local success, err = pcall(handler)
            if not success then
                logAction("Page update error (Page " .. currentPage .. "): " .. tostring(err))
                updateMainPage()
            end
        end

        local event, param = os.pullEvent()
        if event == "key" then
            local success, err = pcall(function() handleMainLoopKeys(event, param) end)
            if not success then
                logAction("Key handling error: " .. tostring(err))
            end
        end
    end
end